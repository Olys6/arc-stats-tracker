name: EAS Build

on:
  # Build on push to main or version tags
  push:
    branches: [main, master]
    tags: ['v*']
  
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

# Permissions needed to create releases and post comments
permissions:
  contents: write

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      
      - name: Install dependencies
        run: npm ci
      
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: Build Android APK
        id: build
        run: |
          # Run build and save JSON output to file
          eas build --platform android --profile preview --non-interactive --json > build_output.json
          
          # Extract URLs from JSON (handle null values)
          BUILD_URL=$(jq -r '.[0].buildDetailsPageUrl // empty' build_output.json)
          ARTIFACT_URL=$(jq -r '.[0].artifacts.buildUrl // empty' build_output.json)
          
          # Fallback to Expo builds page if artifact URL is missing
          if [ -z "$ARTIFACT_URL" ] || [ "$ARTIFACT_URL" = "null" ]; then
            ARTIFACT_URL="$BUILD_URL"
          fi
          
          echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
          echo "artifact_url=$ARTIFACT_URL" >> $GITHUB_OUTPUT
          
          # Debug output
          echo "Build URL: $BUILD_URL"
          echo "Artifact URL: $ARTIFACT_URL"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          # Use tag name if it's a tag, otherwise use "latest"
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'latest' }}
          name: ${{ startsWith(github.ref, 'refs/tags/') && format('Release {0}', github.ref_name) || 'Latest Build' }}
          body: |
            ## Android APK
            
            ðŸ“± **[Download APK](${{ steps.build.outputs.artifact_url }})**
            
            ðŸ”— [View build details on Expo](${{ steps.build.outputs.build_url }})
            
            ### Installation
            1. Download the APK on your Android device
            2. Enable "Install from unknown sources" if prompted
            3. Open the APK to install
            
            ---
            Build: `${{ github.sha }}`
          draft: false
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          make_latest: ${{ startsWith(github.ref, 'refs/tags/') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
